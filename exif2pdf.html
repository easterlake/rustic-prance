<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>File Info and EXIF Reader (Full-Width Thumbnail & PDF Export)</title>
  <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/caldwell/renderjson/renderjson.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f6f8fa; }
    .thumbnail-container {
      margin-bottom: 1em;
      width: 100%;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }
    .thumbnail {
      border: 2px solid #444;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      width: 100%;
      height: auto;
      display: block;
      margin-bottom: 0.5em;
      object-fit: contain;
      background: #fff;
    }
    pre, .json-output {
      background: #23272e;
      color: #f8f8f2;
      padding: 1em;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 1em;
      line-height: 1.5;
      margin-bottom: 1em;
    }
    .json-output {
      font-family: 'Fira Mono', 'Consolas', 'Menlo', monospace;
      margin: 0;
      border: none;
      background: #23272e;
      color: #f8f8f2;
      padding: 1em;
    }
    /* Enhanced JSON styling for renderjson */
    .renderjson-key        { color: #268bd2; font-weight: bold; }
    .renderjson-string     { color: #2aa198; }
    .renderjson-number     { color: #b58900; }
    .renderjson-boolean    { color: #cb4b16; }
    .renderjson-null       { color: #d33682; }
    .renderjson-mark       { background: #44475a; }
    .renderjson-link       { color: #6c71c4; text-decoration: underline; }
    .renderjson-toggle     { color: #ff6188; cursor: pointer; font-weight: bold; }
    .renderjson-separator  { color: #839496; }
    .renderjson-object     { color: #859900; }
    .renderjson-array      { color: #b58900; }
    .renderjson-more       { color: #cb4b16; cursor: pointer; }
    button {
      margin-top: 1em;
      padding: 0.5em 1em;
      font-size: 1em;
      background: #268bd2;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover {
      background: #155ab6;
    }
  </style>
</head>
<body>
  <h2>Select an image file</h2>
  <input type="file" id="fileInput" accept="image/*">
  <div class="thumbnail-container">
    <img id="thumbnail" class="thumbnail" style="display:none;" alt="Image Thumbnail Preview">
  </div>
  <h3>File Info</h3>
  <pre id="fileInfo"></pre>
  <button id="downloadPdf" style="display:none;">Download PDF</button>
  <h3>MD5 Hash</h3>
  <pre id="md5"></pre>
  <h3>EXIF Data</h3>
  <div id="exif" class="json-output"></div>

  <script>
    let lastFileInfo = '';
    let lastMd5 = '';
    let lastExif = {};
    let lastThumbnailDataUrl = '';

    renderjson.set_show_to_level(2);

    document.getElementById('fileInput').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Display file info
      lastFileInfo = `Name: ${file.name}\nSize: ${file.size} bytes\nType: ${file.type}`;
      document.getElementById('fileInfo').textContent = lastFileInfo;

      // Generate and display thumbnail
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          lastThumbnailDataUrl = e.target.result;
          const imgEl = document.getElementById('thumbnail');
          imgEl.src = lastThumbnailDataUrl;
          imgEl.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else {
        document.getElementById('thumbnail').style.display = 'none';
        lastThumbnailDataUrl = '';
      }

      // Compute MD5 hash
      const md5Reader = new FileReader();
      md5Reader.onload = function(e) {
        const arrayBuffer = e.target.result;
        let binary = '';
        const bytes = new Uint8Array(arrayBuffer);
        for (let i = 0; i < bytes.byteLength; i++) {
          binary += String.fromCharCode(bytes[i]);
        }
        lastMd5 = md5(binary);
        document.getElementById('md5').textContent = lastMd5;
      };
      md5Reader.readAsArrayBuffer(file);

      // Extract EXIF data (only works for JPEG, TIFF)
      const exifReader = new FileReader();
      exifReader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          EXIF.getData(img, function() {
            lastExif = EXIF.getAllTags(this);
            const exifDiv = document.getElementById('exif');
            exifDiv.innerHTML = '';
            exifDiv.appendChild(renderjson(lastExif));
            document.getElementById('downloadPdf').style.display = 'inline-block';
          });
        };
        img.src = e.target.result;
      };
      exifReader.readAsDataURL(file);
    });

    document.getElementById('downloadPdf').addEventListener('click', function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'mm', format: 'a4' });

      const pageWidth = 210;
      const pageHeight = 297;
      const margin = 10;
      let y = 20;

      // Header: Date/time generated
      const now = new Date();
      const dateStr = now.toLocaleString();
      doc.setFontSize(10);
      doc.text(`Generated: ${dateStr}`, margin, 10);

      doc.setFont("courier", "normal");
      doc.setFontSize(12);

      // Add thumbnail if available (wait for image to load, then add)
      function addContentAndSave(imgWidth, imgHeight) {
        let yPos = y;
        if (lastThumbnailDataUrl && imgWidth && imgHeight) {
          doc.text("Thumbnail:", margin, yPos);
          yPos += 5;
          // Fit to page width, keep aspect ratio
          const maxWidth = pageWidth - 2 * margin;
          const scale = Math.min(1, maxWidth / imgWidth);
          const drawWidth = imgWidth * scale;
          const drawHeight = imgHeight * scale;
          doc.addImage(lastThumbnailDataUrl, 'JPEG', margin, yPos, drawWidth, drawHeight);
          yPos += drawHeight + 5;
        }

        doc.text("File Info:", margin, yPos);
        yPos += 7;
        lastFileInfo.split('\n').forEach(line => {
          doc.text(line, margin + 2, yPos);
          yPos += 7;
        });

        doc.text("MD5 Hash:", margin, yPos);
        yPos += 7;
        doc.text(lastMd5, margin + 2, yPos);
        yPos += 10;

        doc.text("EXIF Data:", margin, yPos);
        yPos += 7;

        // Stringify and split EXIF JSON for multi-line output
        const exifStr = JSON.stringify(lastExif, null, 2);
        exifStr.split('\n').forEach(line => {
          if (yPos > pageHeight - 20) { // Reserve space for footer
            doc.addPage();
            yPos = 20;
            doc.setFontSize(10);
            doc.text(`Generated: ${dateStr}`, margin, 10);
            doc.setFontSize(12);
            doc.text("EXIF Data (cont'd):", margin, yPos);
            yPos += 7;
          }
          doc.text(line, margin + 2, yPos);
          yPos += 6;
        });

        // Footer: Page X of Y
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i);
          doc.setFontSize(10);
          doc.text(
            `Page ${i} of ${pageCount}`,
            pageWidth - margin,
            pageHeight - 7,
            { align: 'right' }
          );
        }
        doc.save("file_info.pdf");
      }

      if (lastThumbnailDataUrl) {
        const img = new window.Image();
        img.onload = function() {
          addContentAndSave(img.naturalWidth, img.naturalHeight);
        };
        img.onerror = function() {
          // Fallback: skip thumbnail
          addContentAndSave(0, 0);
        };
        img.src = lastThumbnailDataUrl;
      } else {
        addContentAndSave(0, 0);
      }
    });
  </script>
</body>
</html>
